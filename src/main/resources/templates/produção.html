<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produção</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        #produto-sugestoes div {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f9f9f9;
            border-bottom: 1px solid #ddd;
        }
        #produto-sugestoes div:hover {
            background-color: #f1f1f1;
        }
        #produtos-selecionados .produto-item {
            display: flex;
            flex-direction: column;
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .produto-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
    </style>
</head>
<body class="body-geral">
    <div class="cont-login">
        <h1>Registrar Produção</h1>

        <form id="producaoForm" th:action="@{/producao/diaria}" method="post" class="form">
            <input type="hidden" name="dataProducao" th:value="${dataProducao}" />
            <div style="position: relative; margin-bottom: 16px;">
                <input type="text" id="produto-search" autocomplete="off" class="box" placeholder="Pesquisar Produto...">
                <div id="produto-sugestoes"></div>
            </div>

            <h2>Produtos Selecionados</h2>
            <div id="produtos-selecionados"></div>

            <button type="submit" class="box btn-confirm">Confirmar Produção</button>
        </form>
        <div class="links">
            <a th:href="@{/producao/diaria}" class="back-link box">Voltar</a>
        </div>
    </div>

    <script src="/home.js"></script>
    <script th:inline="javascript">
    /*<![CDATA[*/
    var todosProdutos = /*[[${produtos}]]*/ [];

    document.addEventListener('DOMContentLoaded', function() {
        const errosDeEstoque = /*[[${errosDeEstoque}]]*/ null;
        if (errosDeEstoque && errosDeEstoque.length > 0) {
            const mensagemHtml = '<strong>Não foi possível registrar a produção:</strong><br><ul style="margin: 0; padding-left: 20px; text-align: left;">' + 
                                 errosDeEstoque.map(erro => `<li>${erro}</li>`).join('') + 
                                 '</ul>';
            showAlert('error', mensagemHtml, true);
        }
    });
    /*]]>*/
    </script>

    <script>
        const produtoSearch = document.getElementById('produto-search');
        const produtoSugestoes = document.getElementById('produto-sugestoes');
        const produtosSelecionados = document.getElementById('produtos-selecionados');
        const producaoForm = document.getElementById('producaoForm');

        let selectedProducts = [];
        let productIndex = 0;

        produtoSearch.addEventListener('input', () => {
            const termo = produtoSearch.value;
            if (termo.length < 2) {
                produtoSugestoes.innerHTML = '';
                return;
            }

            fetch(`/api/produtos/sugestoes?termo=${termo}`)
                .then(response => response.json())
                .then(data => {
                    produtoSugestoes.innerHTML = '';
                    data.forEach(produto => {
                        const div = document.createElement('div');
                        div.textContent = produto.nome;
                        div.addEventListener('click', () => {
                            const fullProduct = todosProdutos.find(p => p.id === produto.id);
                            addProduto(fullProduct);
                            produtoSearch.value = '';
                            produtoSugestoes.innerHTML = '';
                        });
                        produtoSugestoes.appendChild(div);
                    });
                });
        });

        function addProduto(produto) {
            if (selectedProducts.find(p => p.id === produto.id)) {
                return; // Produto já selecionado
            }

            selectedProducts.push(produto);

            const div = document.createElement('div');
            div.classList.add('produto-item');
            
            const infoDiv = document.createElement('div');
            infoDiv.classList.add('produto-info');
            const span = document.createElement('span');
            span.textContent = produto.nome;

            const divInput = document.createElement('div');

            const quantidadeInput = document.createElement('input');
            quantidadeInput.type = 'number';
            quantidadeInput.name = `produtos[${productIndex}].quantidade`;
            quantidadeInput.min = '1';
            quantidadeInput.required = true;
            quantidadeInput.className = 'box';
            quantidadeInput.style.width = '100px';
            quantidadeInput.style.marginLeft = '10px';
            quantidadeInput.placeholder = 'Qtd';

            const produtoIdInput = document.createElement('input');
            produtoIdInput.type = 'hidden';
            produtoIdInput.name = `produtos[${productIndex}].produtoId`;
            produtoIdInput.value = produto.id;

            divInput.appendChild(quantidadeInput);
            divInput.appendChild(produtoIdInput);

            infoDiv.appendChild(span);
            infoDiv.appendChild(divInput);
            div.appendChild(infoDiv);

            if (produto.nome.toLowerCase().includes('bolo')) {
                const massaSelect = document.createElement('select');
                massaSelect.name = `produtos[${productIndex}].massa`;
                massaSelect.classList.add('box');
                const defaultMassaOption = document.createElement('option');
                defaultMassaOption.value = '';
                defaultMassaOption.textContent = 'Selecione a Massa';
                massaSelect.appendChild(defaultMassaOption);
                todosProdutos.filter(p => p.tipo === 'Massa').forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome;
                    option.textContent = p.nome;
                    massaSelect.appendChild(option);
                });

                const recheioSelect = document.createElement('select');
                recheioSelect.name = `produtos[${productIndex}].recheio`;
                recheioSelect.classList.add('box');
                const defaultRecheioOption = document.createElement('option');
                defaultRecheioOption.value = '';
                defaultRecheioOption.textContent = 'Selecione o Recheio';
                recheioSelect.appendChild(defaultRecheioOption);
                todosProdutos.filter(p => p.tipo === 'Recheio').forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome;
                    option.textContent = p.nome;
                    recheioSelect.appendChild(option);
                });

                div.appendChild(massaSelect);
                div.appendChild(recheioSelect);
            }

            produtosSelecionados.appendChild(div);
            productIndex++;
        }

    </script>
</body>
</html>