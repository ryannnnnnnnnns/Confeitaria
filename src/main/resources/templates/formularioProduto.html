<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produto</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .autocomplete-items div {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f9f9f9;
            border-bottom: 1px solid #ddd;
        }
        .autocomplete-items div:hover {
            background-color: #f1f1f1;
        }
        .selected-ingredient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .remove-ingredient {
            cursor: pointer;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body class="body-geral">
    <div class="cont-principal">
        <div class="menu-lateral" id="menuLateral">
            <button class="toggle-menu" id="toggleMenu">☰</button>
            
            <ul>
                <li><a th:href="@{/home}" class="box">Início</a></li>
                <li><a th:href="@{/estoque}" class="box">Estoque</a></li>
                <li><a th:href="@{/producao}" class="box">Produção</a></li>
                <li><a th:href="@{/vendas}" class="box">Vendas</a></li>
                <li><a th:href="@{/produtos}" class="box">Produtos</a></li>
                <li><a th:href="@{/pedidos}" class="box">Pedidos</a></li>
                <li><a th:href="@{/orcamentos}" class="box">Orçamentos</a></li>
                                <li><a th:href="@{/configuracoes}" class="box">Configurações</a></li>
                
                <li>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="box">Logout</button>
                    </form>
                </li>
            </ul>
        </div>
        <div class="conteudo">
            <div class="conteudo-meio">
                <h1>Cadastro de Produto</h1>
                <form th:action="@{/salvar-produto}" method="post" th:object="${produto}" class="form">
                    <div class="actions">
                        <button type="submit" class="box btn-confirm">Cadastrar</button>
                        <a th:href="@{/produtos}" class="box">Voltar</a>
                    </div>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" th:field="*{id}" />
                    <input type="text" id="nome" name="nome" th:field="*{nome}" required class="box" placeholder="Nome do Produto">
                    <select th:field="*{tipo}" class="box" required>
                        <option value="">Selecione o Tipo</option>
                        <option value="Massa">Massa</option>
                        <option value="Recheio">Recheio</option>
                        <option value="Outros">Outros</option>
                    </select>
                    <input type="number" th:field="*{rendimento}" class="box" placeholder="Rendimento (unidades)" min="1">
                
                    <h3>Ingredientes:</h3>
                    <div class="autocomplete" style="position:relative; display:inline-block; width: 100%;">
                        <input id="ingredientInput" type="text" placeholder="Buscar ingrediente..." class="box">
                        <div id="ingredientSuggestions" class="autocomplete-items"></div>
                    </div>
                    <input type="number" id="quantityInput" placeholder="Quantidade" step="0.01" class="box">
                    <button type="button" id="addIngredientBtn" class="box btn-confirm">Adicionar</button>

                    <div id="selectedIngredientsContainer" style="margin-top: 10px;">
                        <!-- Ingredientes selecionados aparecerão aqui -->
                    </div>
                    
                    <!-- Container para os inputs hidden -->
                    <div id="hiddenInputsContainer"></div>
                </form>
            </div>
        </div>
    </div>
    <script src="/home.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
            window.onload = function() {
                const selectedIngredientsContainer = document.getElementById('selectedIngredientsContainer');
                const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');
                const produto = /*[[${produto}]]*/ null;
                if (produto && produto.ingredientes) {
                    produto.ingredientes.forEach(ingrediente => {
                        // Add visual element
                        const ingredientDiv = document.createElement('div');
                        ingredientDiv.classList.add('selected-ingredient');
                        ingredientDiv.dataset.id = ingrediente.materiaPrima.id;
                        const textSpan = document.createElement('span');
                        textSpan.textContent = `${ingrediente.materiaPrima.nome} - ${ingrediente.quantidade} ${ingrediente.materiaPrima.unidade}`;
                        const removeSpan = document.createElement('span');
                        removeSpan.className = 'remove-ingredient';
                        removeSpan.dataset.id = ingrediente.materiaPrima.id;
                        removeSpan.textContent = 'x';
                        ingredientDiv.appendChild(textSpan);
                        ingredientDiv.appendChild(removeSpan);
                        selectedIngredientsContainer.appendChild(ingredientDiv);

                        // Add hidden inputs
                        const hiddenId = document.createElement('input');
                        hiddenId.type = 'hidden';
                        hiddenId.name = 'ingredientesIds';
                        hiddenId.value = ingrediente.materiaPrima.id;

                        const hiddenQty = document.createElement('input');
                        hiddenQty.type = 'hidden';
                        hiddenQty.name = 'quantidades';
                        hiddenQty.value = ingrediente.quantidade;
                        
                        const hiddenContainer = document.createElement('div');
                        hiddenContainer.dataset.id = ingrediente.materiaPrima.id;
                        hiddenContainer.appendChild(hiddenId);
                        hiddenContainer.appendChild(hiddenQty);
                        hiddenInputsContainer.appendChild(hiddenContainer);
                    });
                }
            };
        /*]]>*/
    </script>

    <script>
        const ingredientInput = document.getElementById('ingredientInput');
        const ingredientSuggestions = document.getElementById('ingredientSuggestions');
        const quantityInput = document.getElementById('quantityInput');
        const addIngredientBtn = document.getElementById('addIngredientBtn');
        const selectedIngredientsContainer = document.getElementById('selectedIngredientsContainer');
        const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');

        let currentSelectedIngredient = null;

        // Fetch suggestions from API
        ingredientInput.addEventListener('input', function() {
            const searchTerm = this.value;
            currentSelectedIngredient = null; 
            if (searchTerm.length < 2) {
                ingredientSuggestions.innerHTML = '';
                return;
            }

            fetch(`/api/materia-prima/sugestoes?termo=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    ingredientSuggestions.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(item => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = `${item.nome} (${item.unidade})`;
                            suggestionDiv.addEventListener('click', function() {
                                ingredientInput.value = `${item.nome} (${item.unidade})`;
                                currentSelectedIngredient = item;
                                ingredientSuggestions.innerHTML = ''; 
                            });
                            ingredientSuggestions.appendChild(suggestionDiv);
                        });
                    } else {
                        ingredientSuggestions.innerHTML = '<div>Nenhuma sugestão encontrada</div>';
                    }
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });

        // Add ingredient to the list
        addIngredientBtn.addEventListener('click', function() {
            const quantity = parseFloat(quantityInput.value);
            if (!currentSelectedIngredient || !quantity || quantity <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Por favor, selecione um ingrediente e insira uma quantidade válida.'
                });
                return;
            }

            const ingredientId = currentSelectedIngredient.id;

            // Check if ingredient is already added
            if (document.querySelector(`.selected-ingredient[data-id='${ingredientId}']`)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Este ingrediente já foi adicionado.'
                });
                return;
            }

            // Add visual element
            const ingredientDiv = document.createElement('div');
            ingredientDiv.classList.add('selected-ingredient');
            ingredientDiv.dataset.id = ingredientId;
            const textSpan = document.createElement('span');
            textSpan.textContent = `${currentSelectedIngredient.nome} - ${quantity} ${currentSelectedIngredient.unidade}`;
            const removeSpan = document.createElement('span');
            removeSpan.className = 'remove-ingredient';
            removeSpan.dataset.id = ingredientId;
            removeSpan.textContent = 'x';
            ingredientDiv.appendChild(textSpan);
            ingredientDiv.appendChild(removeSpan);
            selectedIngredientsContainer.appendChild(ingredientDiv);

            // Add hidden inputs
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'ingredientesIds';
            hiddenId.value = ingredientId;

            const hiddenQty = document.createElement('input');
            hiddenQty.type = 'hidden';
            hiddenQty.name = 'quantidades';
            hiddenQty.value = quantity;
            
            const hiddenContainer = document.createElement('div');
            hiddenContainer.dataset.id = ingredientId;
            hiddenContainer.appendChild(hiddenId);
            hiddenContainer.appendChild(hiddenQty);
            hiddenInputsContainer.appendChild(hiddenContainer);

            // Reset inputs
            ingredientInput.value = '';
            quantityInput.value = '';
            currentSelectedIngredient = null;
        });

        // Remove ingredient from the list
        selectedIngredientsContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-ingredient')) {
                const removeId = e.target.dataset.id;
                
                // Remove visual element
                const visualDiv = document.querySelector(`.selected-ingredient[data-id='${removeId}']`);
                if (visualDiv) visualDiv.remove();

                // Remove hidden inputs
                const hiddenDiv = document.querySelector(`#hiddenInputsContainer > div[data-id='${removeId}']`);
                if (hiddenDiv) hiddenDiv.remove();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!ingredientInput.contains(e.target) && !ingredientSuggestions.contains(e.target)) {
                ingredientSuggestions.innerHTML = '';
            }
        });
    </script>
</body>
</html>