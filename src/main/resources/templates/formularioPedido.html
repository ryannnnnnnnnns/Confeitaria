<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css">
    <title>Novo Pedido</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .autocomplete-items div {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f9f9f9;
            border-bottom: 1px solid #ddd;
        }
        .autocomplete-items div:hover {
            background-color: #f1f1f1;
        }
        .selected-item {
            display: flex;
            flex-direction: column; /* Changed to column */
            justify-content: space-between;
            align-items: flex-start; /* Changed to flex-start */
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .remove-item {
            cursor: pointer;
            color: red;
            font-weight: bold;
            align-self: flex-end; /* Align remove button to the right */
        }
        .item-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body class="body-geral">
    <div class="cont-principal">
        <div class="menu-lateral" id="menuLateral">
            <button class="toggle-menu" id="toggleMenu">☰</button>
            
            <ul>
                <li><a th:href="@{/home}" class="box">Início</a></li>
                <li><a th:href="@{/estoque}" class="box">Estoque</a></li>
                <li><a th:href="@{/producao}" class="box">Produção</a></li>
                <li><a th:href="@{/vendas}" class="box">Vendas</a></li>
                <li><a th:href="@{/produtos}" class="box">Produtos</a></li>
                <li><a th:href="@{/pedidos}" class="box">Pedidos</a></li>
                <li><a th:href="@{/orcamentos}" class="box">Orçamentos</a></li>
                <li><a th:href="@{/configuracoes}" class="box">Configurações</a></li>
                
                <li>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="box">Logout</button>
                    </form>
                </li>
            </ul>
        </div>
        <div class="conteudo">
            <div class="conteudo-meio">
                <h1>Novo Pedido</h1>
                <form id="pedido-form" th:action="@{/pedido/salvar}" method="post" class="form">
                    <div class="actions">
                        <button type="submit" class="box btn-confirm">Salvar Pedido</button>
                        <a th:href="@{/pedidos}" class="box">Voltar</a>
                    </div>
                    <input type="text" id="cliente" name="cliente" class="box" placeholder="Nome do Cliente" required>
                    <input type="date" id="dataEntrega" name="dataEntrega" class="box" required>

                    <h2>Itens do Pedido</h2>
                    
                    <div class="autocomplete" style="position:relative; display:inline-block; width: 100%;">
                        <input id="produtoInput" type="text" placeholder="Buscar produto..." class="box">
                        <div id="produtoSuggestions" class="autocomplete-items"></div>
                    </div>
                    <input type="number" id="quantityInput" placeholder="Quantidade" step="1" min="1" class="box">
                    <button type="button" id="addItemBtn" class="box btn-confirm">Adicionar Item</button>

                    <div id="selectedItemsContainer" style="margin-top: 10px;">
                        <!-- Itens selecionados aparecerão aqui -->
                    </div>
                    
                    <!-- Container para os inputs hidden -->
                    <div id="hiddenInputsContainer"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="/home.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var produtos = /*[[${produtos}]]*/ [];
        /*]]>*/

        const produtoInput = document.getElementById('produtoInput');
        const produtoSuggestions = document.getElementById('produtoSuggestions');
        const quantityInput = document.getElementById('quantityInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const selectedItemsContainer = document.getElementById('selectedItemsContainer');
        const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');
        const form = document.getElementById('pedido-form');

        let currentSelectedProduto = null;
        let itemIndex = 0;

        // Fetch product suggestions from API
        produtoInput.addEventListener('input', function() {
            const searchTerm = this.value;
            currentSelectedProduto = null; 
            if (searchTerm.length < 2) {
                produtoSuggestions.innerHTML = '';
                return;
            }

            fetch(`/api/produtos/sugestoes?termo=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    produtoSuggestions.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(item => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = item.nome;
                            suggestionDiv.addEventListener('click', function() {
                                produtoInput.value = item.nome;
                                // Find the full product object from the initial list
                                currentSelectedProduto = produtos.find(p => p.id === item.id);
                                produtoSuggestions.innerHTML = ''; 
                            });
                            produtoSuggestions.appendChild(suggestionDiv);
                        });
                    } else {
                        produtoSuggestions.innerHTML = '<div>Nenhuma sugestão encontrada</div>';
                    }
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });

        // Add item to the list
        addItemBtn.addEventListener('click', function() {
            const quantity = parseInt(quantityInput.value, 10);
            if (!currentSelectedProduto || !quantity || quantity <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Por favor, selecione um produto e insira uma quantidade válida.'
                });
                return;
            }

            const produtoId = currentSelectedProduto.id;

            // Check if item is already added
            if (document.querySelector(`.selected-item[data-id='${produtoId}']`)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Este produto já foi adicionado.'
                });
                return;
            }

            // Add visual element
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('selected-item');
            itemDiv.dataset.id = produtoId;
            
            const itemInfo = document.createElement('div');
            itemInfo.classList.add('item-info');
            const span = document.createElement('span');
            span.textContent = `${currentSelectedProduto.nome} - ${quantity}`;
            const removeSpan = document.createElement('span');
            removeSpan.className = 'remove-item';
            removeSpan.dataset.id = produtoId;
            removeSpan.textContent = 'x';
            itemInfo.appendChild(span);
            itemInfo.appendChild(removeSpan);
            itemDiv.appendChild(itemInfo);

            selectedItemsContainer.appendChild(itemDiv);

            // Add hidden inputs
            const hiddenContainer = document.createElement('div');
            hiddenContainer.dataset.id = produtoId;

            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = `itens[${itemIndex}].produtoId`;
            hiddenId.value = produtoId;

            const hiddenQty = document.createElement('input');
            hiddenQty.type = 'hidden';
            hiddenQty.name = `itens[${itemIndex}].quantidade`;
            hiddenQty.value = quantity;
            
            hiddenContainer.appendChild(hiddenId);
            hiddenContainer.appendChild(hiddenQty);

            // Add special fields for "Bolo"
            if (currentSelectedProduto.nome.toLowerCase().includes('bolo')) {
                // Massa dropdown
                const massaSelect = document.createElement('select');
                massaSelect.name = `itens[${itemIndex}].massa`;
                massaSelect.classList.add('box');
                const defaultMassaOption = document.createElement('option');
                defaultMassaOption.value = '';
                defaultMassaOption.textContent = 'Selecione a Massa';
                massaSelect.appendChild(defaultMassaOption);
                produtos.filter(p => p.tipo === 'Massa').forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome;
                    option.textContent = p.nome;
                    massaSelect.appendChild(option);
                });

                // Recheio dropdown
                const recheioSelect = document.createElement('select');
                recheioSelect.name = `itens[${itemIndex}].recheio`;
                recheioSelect.classList.add('box');
                const defaultRecheioOption = document.createElement('option');
                defaultRecheioOption.value = '';
                defaultRecheioOption.textContent = 'Selecione o Recheio';
                recheioSelect.appendChild(defaultRecheioOption);
                produtos.filter(p => p.tipo === 'Recheio').forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome;
                    option.textContent = p.nome;
                    recheioSelect.appendChild(option);
                });

                const detalhesInput = document.createElement('textarea');
                detalhesInput.name = `itens[${itemIndex}].detalhes`;
                detalhesInput.classList.add('box');
                detalhesInput.placeholder = 'Detalhes (ex: cor, tema, etc)';

                itemDiv.appendChild(massaSelect);
                itemDiv.appendChild(recheioSelect);
                itemDiv.appendChild(detalhesInput);
            }

            hiddenInputsContainer.appendChild(hiddenContainer);

            // Reset inputs
            produtoInput.value = '';
            quantityInput.value = '';
            currentSelectedProduto = null;
            itemIndex++;
        });

        // Remove item from the list
        selectedItemsContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-item')) {
                const removeId = e.target.dataset.id;
                
                // Remove visual element
                const visualDiv = document.querySelector(`.selected-item[data-id='${removeId}']`);
                if (visualDiv) visualDiv.remove();

                // Remove hidden inputs
                const hiddenDiv = document.querySelector(`#hiddenInputsContainer > div[data-id='${removeId}']`);
                if (hiddenDiv) hiddenDiv.remove();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!produtoInput.contains(e.target) && !produtoSuggestions.contains(e.target)) {
                produtoSuggestions.innerHTML = '';
            }
        });
    </script>
</body>

</html>
